<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client List Reminders ‚Äî User</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics-compat.js"></script>

  <!-- ‚úÖ Firebase Initialization -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD8KyIuPpW4w9vwEwfzemhxYYp2nJy4Io8",
      authDomain: "client-management-f6060.firebaseapp.com",
      projectId: "client-management-f6060",
      storageBucket: "client-management-f6060.appspot.com",
      messagingSenderId: "267148533200",
      appId: "1:267148533200:web:59f74ba662122c81c22dd5",
      measurementId: "G-M6QEGME5SZ"
    };
    firebase.initializeApp(firebaseConfig);
    if (typeof firebase.analytics === 'function') { firebase.analytics(); }
  </script>

  <style>
    :root {
      --bg: #f6f7fb; --card: #fff; --text: #0f172a; --muted: #64748b;
      --primary: #008CBA; --primary-contrast: #fff; --accent: #22c55e;
      --warn: #f59e0b; --danger: #ef4444; --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(2,6,23,0.08); --radius:14px; --pad:14px;
    }
    [data-theme="dark"] {
      --bg:#0b1220; --card:#111a2c; --text:#e5e7eb; --muted:#9aa7bd;
      --primary:#3b82f6; --primary-contrast:#0b1220; --accent:#22c55e;
      --warn:#fbbf24; --danger:#ef4444; --border:#1f2a44; --shadow:0 10px 30px rgba(0,0,0,.5);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{margin:0;padding:16px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;line-height:1.45;}
    .container{max-width:1100px;margin:0 auto;}
    h1,h2,h3{margin:0 0 10px;}
    .muted{color:var(--muted);}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:calc(var(--pad)*1.2);}
    .row{display:grid;gap:10px;}
    .topbar{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;margin-bottom:14px;}
    .brand{font-weight:800;letter-spacing:.3px;}
    .btn,button{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);cursor:pointer;transition: transform .06s ease, background .2s ease, border-color .2s ease;}
    .btn:hover{transform:translateY(-1px);}
    .btn.primary{background:var(--primary);color:var(--primary-contrast);border-color:transparent;}
    .btn.success{background:var(--accent);color:#fff;border-color:transparent;}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent;}
    .btn.ghost{background:transparent;}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);outline:none;}
    textarea{min-height:70px;resize:vertical;}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);}
    .menu-wrap{position:relative;}
    .menu{position:absolute;top:calc(100%+6px);right:0;min-width:260px;z-index:10;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:8px;display:none;}
    .menu.open{display:block;}
    .menu .item{padding:10px;border-radius:10px;cursor:pointer;}
    .menu .item:hover{background: rgba(100,116,139,.16);}
    .hide{display:none !important;}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin:14px 0 8px;font-weight:700;}
    .list{display:grid;gap:8px;}
    .client{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-left:6px solid var(--primary);border-radius:12px;padding:12px;background:var(--card);}
    .client.overdue{border-left-color: var(--danger);background: rgba(239,68,68,.08);}
    .client.today{border-left-color: var(--warn);background: rgba(245,158,11,.10);}
    .client.paid{border-left-color: var(--accent);background: rgba(34,197,94,.10);}
    .info{display:grid;gap:6px;}
    @media (min-width:900px){.info{grid-template-columns:1.2fr 1fr 1fr 1fr;}}
    details summary{cursor:pointer;user-select:none;}
    .label{font-size:.78rem;color:var(--muted);}
    .value{font-weight:600;}
    .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;}
    .dialog-backdrop.open{display:flex;}
    .dialog{max-width:520px;width:100%;}
  .dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}

@media(max-width:600px){
  .client{padding:10px;font-size:14px;}
  .btn{width:100%;padding:15px;}
}

/* Tablet */
@media(min-width:601px) and (max-width:1024px){
  .client{padding:15px;font-size:16px;}
  .btn{width:auto;}
}

/* ===== Small action buttons for client cards ===== */
.client .actions .btn {
  padding: 6px 8px;
  font-size: 0.85rem;
}

@media(max-width:600px){
  .client .actions .btn {
    padding: 4px 6px;
    font-size: 0.75rem;
  }
}

@media(min-width:601px) and (max-width:900px){
  .client .actions .btn {
    padding: 5px 7px;
    font-size: 0.8rem;
  }
}

@media(min-width:901px){
  .client .actions .btn {
    padding: 6px 10px;
    font-size: 0.9rem;
  }
}

.spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

 /* ‚úÖ Fix calendar button dark mode issue */
  input[type="date"] {
    color-scheme: light !important; /* force light theme calendar */
  }

  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1); /* make icon visible on dark mode */
    cursor: pointer;
  }
  
  /* Make client info readable on small screens */
@media (max-width: 600px) {
  .client .info {
    display: block;            /* stack fields instead of grid */
  }

  .client .info > div {
    margin-bottom: 10px;
  }

  .client .label {
    font-size: 14px;
    display: block;
    margin-bottom: 2px;
  }

  .client .value,
  .client .inp {
    font-size: 16px;
    width: 100%;               /* full width inputs */
  }

  .client {
    font-size: 14px;
    padding: 12px;
  }

  .client .actions {
    flex-direction: column;    /* stack buttons vertically */
    gap: 6px;
  }
}

  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="loginView">
      <div class="card" style="max-width:520px;margin:8vh auto;">
        <h1 style="text-align:center;">Client List Reminders</h1>
        <p class="muted" style="text-align:center;margin-bottom:14px;">v.02</p>
        <div class="row" style="gap:14px;">
          <div class="card">
            <h3>Login</h3>
            <form id="loginForm" class="row" style="gap:10px;margin-top:8px;">
              <input id="loginUsername" type="text" placeholder="Username" required />
              <input id="loginPassword" type="password" placeholder="Password" required />
              <button class="btn primary" type="submit">Login</button>
              <button id="forgotBtn" class="btn ghost" type="button">Forgot Password?</button>
            </form>
          </div>
          <div class="card">
            <h3>Create Account</h3>
            <button id="createAccountBtn" class="btn success" type="button">Create Account</button>
            <p class="muted" style="margin-top:6px;">Make our client satisfied</p>
          </div>
        </div>
      </div>
    </div>

    <div id="loadingSpinner" class="spinner" style="display:none;margin:20px auto;"></div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="dialog-backdrop">
    <div class="dialog card">
      <h3>Create Account</h3>
      <form id="registerForm" class="row" style="gap:10px;">
        <input id="regUsername" type="text" placeholder="Username (unique)" required />
        <input id="regEmail" type="email" placeholder="Email (used for login & reset)" required />
        <input id="regPassword" type="password" placeholder="Password" required />
        <input id="regQ" type="text" placeholder="(Optional) Recovery note for yourself" />
        <input id="regA" type="text" placeholder="(Optional) Recovery note answer" />
        <div class="actions">
          <button class="btn success" type="submit">Create Account</button>
          <button class="btn ghost" type="button" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="appView" class="hide">
    <!-- Topbar & Menu -->
    <div class="topbar">
      <div class="brand">üìí Client List Reminders</div>
      <div class="muted" id="whoami"></div>
      <div class="menu-wrap">
        <button id="moreBtn" class="btn">‚ò∞ Menu</button>
        <div id="moreMenu" class="menu">
          <div class="item" id="exportExcel">üì• Export to Excel</div>
          <div class="item" id="backupBtn">üíæ Backup (download .json)</div>
          <label class="item" for="restoreInput" style="display:block;cursor:pointer;">üì§ Restore (upload .json)</label>
          <input id="restoreInput" type="file" accept=".json,application/json" class="hide" />
          <div class="item" id="darkToggle">üåì Toggle Dark</div>
          <div class="item" id="logoutBtn">üö™ Logout</div>
        </div>
      </div>
    </div>

    <!-- Settings & Email Template -->
    <div class="card" style="margin-bottom:12px;">
      <details>
        <summary><strong>‚úâÔ∏è Email Reminder Template</strong> <span class="muted">(per user)</span></summary>
        <div class="row" style="margin-top:10px;grid-template-columns:1fr;">
          <input id="tplSubject" type="text" placeholder="Subject (e.g., Payment Reminder for {{name}})" />
          <textarea id="tplBody" placeholder="Body. Use {{name}}, {{next}}, {{plan}} tokens."></textarea>
          <button id="saveTpl" class="btn">Save Template</button>
          <p class="muted">Your registered email will be used as the sender by your email app.</p>
        </div>
      </details>
    </div>

    <!-- Add Client -->
    <div class="card" style="margin-bottom:12px;">
      <form id="clientForm" class="row" style="grid-template-columns:1.2fr 1fr 1fr 1fr 1fr 1fr auto;">
        <input type="text" id="clientName" placeholder="Client Name" required />
        <input type="email" id="clientEmail" placeholder="Client Email" />
        <input type="text" id="clientPhone" placeholder="Contact No." />
        <input type="text" id="clientAddress" placeholder="Address" />
        <input type="date" id="startDate" required />
        <input type="text" id="clientPlan" placeholder="Plan (e.g. $50)" required />
        <button class="btn primary" type="submit">Add</button>
      </form>
    </div>

    <!-- Filters -->
    <div class="card" style="margin-bottom:12px;">
      <div class="row" style="grid-template-columns: 2fr 1fr 1fr;">
        <input id="searchInput" type="text" placeholder="Search by client name‚Ä¶" />
        <select id="filterSelect">
          <option value="all">All</option>
          <option value="due-month">Due this month</option>
          <option value="overdue">Overdue</option>
          <option value="upcoming">Upcoming (later)</option>
        </select>
        <select id="sortSelect">
          <option value="name-asc">Sort: Name ‚Üë</option>
          <option value="name-desc">Sort: Name ‚Üì</option>
          <option value="date-asc">Sort: Next payment ‚Üë</option>
          <option value="date-desc">Sort: Next payment ‚Üì</option>
          <option value="plan-asc">Sort: Plan ‚Üë</option>
          <option value="plan-desc">Sort: Plan ‚Üì</option>
        </select>
      </div>
    </div>

    <!-- Lists -->
    <div>
      <div class="section-title">
        <span>üìÖ This Month</span>
        <span class="muted" id="countThisMonth">0</span>
      </div>
      <div id="dueList" class="list"></div>

      <div class="section-title" style="margin-top:18px;">
        <span>‚úÖ Paid / Later</span>
        <span class="muted" id="countLater">0</span>
      </div>
      <div id="paidList" class="list"></div>
    </div>
  </div>

  <!-- Dialog -->
  <div id="dialogBackdrop" class="dialog-backdrop">
    <div class="dialog card">
      <h3 id="dialogTitle">Dialog</h3>
      <div id="dialogBody" class="row"></div>
      <div class="actions">
        <button id="dialogCancel" class="btn">Cancel</button>
        <button id="dialogOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

<script>
/* ======== Helpers & Globals ======== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const auth = firebase.auth();
const db   = firebase.firestore();

function setTheme(d){ document.documentElement.setAttribute('data-theme', d?'dark':'light'); }
function escapeHtml(s=''){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}
function escapeAttr(s=''){return escapeHtml(s)}
const today0 = () => { const d = new Date(); d.setHours(0,0,0,0); return d; };
function formatDate(d){ return d.toISOString().split('T')[0]; }
function nextPaymentFrom(startDate){
  const now = today0();
  const next = new Date(startDate); next.setHours(0,0,0,0);
  while(next < now){ next.setMonth(next.getMonth()+1); }
  return next;
}
function isToday(dateObj){ const t=today0().getTime(); const d=new Date(dateObj); d.setHours(0,0,0,0); return d.getTime()===t; }
function isThisMonth(dateObj){ const t=today0(); return dateObj.getMonth()===t.getMonth() && dateObj.getFullYear()===t.getFullYear(); }
function isOverdue(dateObj){ const now=today0(); const d=new Date(dateObj); d.setHours(0,0,0,0); return d<now; }

let currentUser = null;         // firebase.User
let currentProfile = null;      // {username, email, prefs...}
let clientsCache = [];          // array of {id, name, ...}
let unsubClients = null;        // onSnapshot unsubscribe

/* ======== Username <-> email mapping ========
   We let users login with a USERNAME. We store mapping in:
   Collection: "usernames", doc id = usernameLower, fields { uid, email }
   User profile: "users/{uid}" doc stores { username, email, prefs... }
=============================================*/

function showSpinner(show){ $('#loadingSpinner').style.display = show ? 'block' : 'none'; }

/* ======== Auth Wiring ======== */
async function register(username, email, password, q, a){
  username = (username||'').trim();
  email = (email||'').trim();
  if(!username || !email || !password) return alert('Please fill username, email and password.');
  const userKey = username.toLowerCase();

  showSpinner(true);
  try{
    // Check username availability
    const handle = await db.collection('usernames').doc(userKey).get();
    if (handle.exists) { alert('Username already exists.'); return; }

    // Create auth account
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const uid = cred.user.uid;

    // Save profile
    const profile = {
      username, email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      prefs: { darkMode:false, tplSubject:'Payment Reminder for {{name}}', tplBody:'Hello {{name}},\n\nYour next payment is due on {{next}} for {{plan}}.\n\nThank you.' },
      recoveryQ: q || '', recoveryA: a || ''
    };
    await db.collection('users').doc(uid).set(profile);

    // Save username handle
    await db.collection('usernames').doc(userKey).set({ uid, email });

    alert('Account created! You can now login.');
    closeModal();
  } catch(err){
    console.error(err);
    alert(err.message || 'Could not create account.');
  } finally {
    showSpinner(false);
  }
}

async function login(username, password){
  username = (username||'').trim();
  if(!username || !password) return;
  showSpinner(true);
  try{
    // Find email by username
    const userKey = username.toLowerCase();
    const handle = await db.collection('usernames').doc(userKey).get();
    if(!handle.exists){ alert('Invalid username or password.'); return; }
    const { email } = handle.data();
    await auth.signInWithEmailAndPassword(email, password);
    // onAuthStateChanged will continue the flow
  } catch(err){
    console.error(err);
    alert('Invalid username or password.');
  } finally {
    showSpinner(false);
  }
}

function logout(){
  if(unsubClients) { unsubClients(); unsubClients = null; }
  clientsCache = [];
  currentProfile = null;
  auth.signOut();
  $('#appView').classList.add('hide');
  $('#loginView').classList.remove('hide');
  setTheme(false);
  $('#loginForm').reset();
}

auth.onAuthStateChanged(async (user)=>{
  if(!user){
    // back to login
    $('#whoami').textContent = '';
    $('#loginView').classList.remove('hide');
    $('#appView').classList.add('hide');
    return;
  }
  currentUser = user;
  // Load profile
  const profSnap = await db.collection('users').doc(user.uid).get();
  currentProfile = profSnap.exists ? profSnap.data() : { email: user.email, username: user.email.split('@')[0], prefs:{} };

  setTheme(!!currentProfile?.prefs?.darkMode);
  $('#whoami').textContent = `${currentProfile.username} ‚Ä¢ ${currentProfile.email}`;

  // Prefill template UI
  const p = currentProfile.prefs || {};
  $('#tplSubject').value = p.tplSubject || 'Payment Reminder for {{name}}';
  $('#tplBody').value    = p.tplBody || 'Hello {{name}},\n\nYour next payment is due on {{next}} for {{plan}}.\n\nThank you.';

  // Subscribe to clients in real-time
  if(unsubClients) unsubClients();
  unsubClients = db.collection('users').doc(user.uid).collection('clients')
    .orderBy('name')
    .onSnapshot(snap=>{
      clientsCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      render();
    });

  $('#loginView').classList.add('hide');
  $('#appView').classList.remove('hide');
});

/* ======== Clients / Prefs (Firestore) ======== */
function getClients(){ return clientsCache || []; }
function statusFor(c){
  const next = nextPaymentFrom(new Date(c.startDate));
  if (isToday(next)) return 'Due Today';
  if (isThisMonth(next)) return 'Due This Month';
  return 'Paid for Next Month';
}

async function addClient(c){
  if(!currentUser) return;
  await db.collection('users').doc(currentUser.uid).collection('clients').add(c);
}

async function updateClient(id, patch){
  if(!currentUser || !id) return;
  await db.collection('users').doc(currentUser.uid).collection('clients').doc(id).update(patch);
}

async function deleteClient(id){
  if(!currentUser || !id) return;
  await db.collection('users').doc(currentUser.uid).collection('clients').doc(id).delete();
}

async function savePrefs(patch){
  if(!currentUser) return;
  const next = { ...(currentProfile||{}), prefs: { ...(currentProfile?.prefs||{}), ...patch } };
  await db.collection('users').doc(currentUser.uid).update({ prefs: next.prefs });
  currentProfile = next;
}

/* ======== UI Actions kept from your code, but now using Firestore ======== */
function render(){
  const dueWrap = $('#dueList'), paidWrap = $('#paidList');
  dueWrap.innerHTML=''; paidWrap.innerHTML='';

  let list = getClients().map((c,i)=>({ ...c, _index:i, _next: nextPaymentFrom(new Date(c.startDate)) }));

  const q = $('#searchInput').value.trim().toLowerCase();
  if(q) list = list.filter(c => (c.name||'').toLowerCase().includes(q));

  const filt = $('#filterSelect').value;
  if(filt==='due-month') list = list.filter(c => isThisMonth(c._next));
  if(filt==='overdue') list = list.filter(c => isOverdue(c._next));
  if(filt==='upcoming') list = list.filter(c => !isThisMonth(c._next) && !isOverdue(c._next));

  const sort = $('#sortSelect').value;
  const n = v => (parseFloat((v||'').replace(/[^0-9.]/g,''))||0);
  const cmp = {
    'name-asc': (a,b)=>(a.name||'').localeCompare(b.name||''),
    'name-desc':(a,b)=>(b.name||'').localeCompare(a.name||''),
    'date-asc': (a,b)=> a._next - b._next,
    'date-desc':(a,b)=> b._next - a._next,
    'plan-asc': (a,b)=> n(a.plan) - n(b.plan),
    'plan-desc':(a,b)=> n(b.plan) - n(a.plan),
  }[sort] || ((a,b)=>0);
  list.sort(cmp);

  let countThis=0, countLater=0;
  list.forEach(c=>{
    const nextStr = formatDate(c._next);
    const dueToday = isToday(c._next);
    const inThisMonth = isThisMonth(c._next);
    const overdue = isOverdue(new Date(c._next.getTime()-86400000));

    const card = document.createElement('div');
    card.className = 'client';
    if (c.justPaid) card.classList.add('paid');
    if (dueToday) card.classList.add('today');
    if (overdue) card.classList.add('overdue');

    const details = `
      <details>
        <summary class="muted">More info</summary>
        <div class="row" style="margin-top:8px; grid-template-columns: 1fr 1fr;">
          <label class="label">Email</label><input class="inp email" data-i="${c._index}" type="email" value="${escapeAttr(c.email||'')}"/>
          <label class="label">Phone</label><input class="inp phone" data-i="${c._index}" type="text" value="${escapeAttr(c.phone||'')}"/>
          <label class="label">Address</label><input class="inp addr" data-i="${c._index}" type="text" value="${escapeAttr(c.address||'')}"/>
          <label class="label">Notes</label><textarea class="inp notes" data-i="${c._index}">${escapeHtml(c.notes||'')}</textarea>
        </div>
      </details>`;

    card.innerHTML = `
      <div class="info">
        <div><div class="label">Name</div><div class="value">${escapeHtml(c.name||'')}</div></div>
        <div><div class="label">Plan</div><div><input class="inp plan" data-i="${c._index}" type="text" value="${escapeAttr(c.plan||'')}" /></div></div>
        <div><div class="label">Start Date</div><div><input class="inp date" data-i="${c._index}" type="date" value="${escapeAttr(c.startDate||'')}" /></div></div>
        <div><div class="label">Next Payment</div><div class="value">${dueToday?'üüß Today':nextStr}</div></div>
      </div>
      <div class="actions" style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn success paid" data-i="${c._index}">‚úÖ Mark Paid</button>
        <button class="btn" data-action="email" data-i="${c._index}">‚úâÔ∏è Email</button>
        <button class="btn danger del" data-i="${c._index}">üóëÔ∏è Delete</button>
      </div>
      ${details}
    `;
    if(inThisMonth){ dueWrap.appendChild(card); countThis++; } else { paidWrap.appendChild(card); countLater++; }
  });
  $('#countThisMonth').textContent = countThis;
  $('#countLater').textContent = countLater;

  // Bind actions
  $$('.btn.success.paid').forEach(b=>b.addEventListener('click', onMarkPaid));
  $$('.btn.danger.del').forEach(b=>b.addEventListener('click', onDelete));
  $$('.inp.date').forEach(i=>i.addEventListener('change', onEditDate));
$$('.inp.plan').forEach(i=>i.addEventListener('blur', onEditPlan));
$$('.inp.email').forEach(i=>i.addEventListener('blur', onEditEmail));
$$('.inp.phone').forEach(i=>i.addEventListener('blur', onEditPhone));
$$('.inp.addr').forEach(i=>i.addEventListener('blur', onEditAddr));
$$('.inp.notes').forEach(i=>i.addEventListener('blur', onEditNotes));
  $$('button[data-action="email"]').forEach(b=>b.addEventListener('click', onEmail));
}

/* ======== Client item handlers (Firestore updates) ======== */
async function onMarkPaid(e){
  const i = +e.currentTarget.dataset.i;
  const item = getClients()[i]; if(!item) return;
  if(!confirm('Mark as paid and move next payment by 1 month?')) return;
  const d = new Date(item.startDate); d.setMonth(d.getMonth()+1);
  await updateClient(item.id, { startDate: formatDate(d) });
}

async function onDelete(e) {
  const i = +e.currentTarget.dataset.i;
  const item = getClients()[i]; if(!item) return;
  if (!confirm(`Are you sure you want to delete ${item.name || 'this client'}? This action cannot be undone.`)) return;
  await deleteClient(item.id);
}
async function onEditDate(e){
  const i = +e.currentTarget.dataset.i;
  const item = getClients()[i]; if(!item) return;
  await updateClient(item.id, { startDate: e.currentTarget.value });
}
async function onEditPlan(e){
  const i = +e.currentTarget.dataset.i;
  const item = getClients()[i]; if(!item) return;
  await updateClient(item.id, { plan: e.currentTarget.value });
}
async function onEditEmail(e){
  const i = +e.currentTarget.dataset.i;
  const item = getClients()[i]; if(!item) return;
  await updateClient(item.id, { email: e.currentTarget.value });
}
async function onEditPhone(e){
  const i = +e.currentTarget.dataset.i;
  const item = getClients()[i]; if(!item) return;
  await updateClient(item.id, { phone: e.currentTarget.value });
}
async function onEditAddr(e){
  const i = +e.currentTarget.dataset.i;
  const item = getClients()[i]; if(!item) return;
  await updateClient(item.id, { address: e.currentTarget.value });
}
async function onEditNotes(e){
  const i = +e.currentTarget.dataset.i;
  const item = getClients()[i]; if(!item) return;
  await updateClient(item.id, { notes: e.currentTarget.value });
}

function onEmail(e){
  const i = +e.currentTarget.dataset.i;
  const c = getClients()[i]; if(!c) return;
  const next = formatDate(nextPaymentFrom(new Date(c.startDate)));
  const p = currentProfile?.prefs || {};
  const subject = encodeURIComponent((p.tplSubject || 'Payment Reminder for {{name}}')
    .replace(/{{name}}/g, c.name||'').replace(/{{next}}/g, next).replace(/{{plan}}/g, c.plan||''));
  const body = encodeURIComponent((p.tplBody || 'Hello {{name}},\n\nYour next payment is due on {{next}} for {{plan}}.\n\nThank you.')
    .replace(/{{name}}/g, c.name||'').replace(/{{next}}/g, next).replace(/{{plan}}/g, c.plan||''));
  const to = encodeURIComponent(c.email || '');
  const footer = `%0D%0A%0D%0ASent from: ${encodeURIComponent(currentUser?.email||'')}`;
  location.href = `mailto:${to}?subject=${subject}&body=${body}${footer}`;
}

/* ======== Export / Backup / Restore / Prefs ======== */
function exportToExcel(){
  const list = getClients().map(c=>({ ...c, _next: nextPaymentFrom(new Date(c.startDate)) }));
  const order = { 'Due Today':0, 'Due This Month':1, 'Paid for Next Month':2 };
  list.sort((a,b)=> (order[statusFor(a)] - order[statusFor(b)]) || (a._next - b._next));
  const data = list.map(c=>({
    "Client Name": c.name, "Email": c.email || '', "Phone": c.phone || '',
    "Address": c.address || '', "Plan": c.plan || '', "Start Date": c.startDate,
    "Next Payment": formatDate(c._next), "Status": statusFor(c), "Notes": c.notes || ''
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Clients");
  XLSX.writeFile(wb, `${(currentProfile?.username)||'user'}_Clients.xlsx`);
}
function download(filename, text){
  const blob = new Blob([text], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}
function backupUser(){
  const payload = { username: currentProfile?.username || '', clients: getClients() };
  download(`${(currentProfile?.username)||'user'}_backup.json`, JSON.stringify(payload,null,2));
}
async function restoreUser(file) {
  if (!currentUser) return;
  const reader = new FileReader();
  reader.onload = async () => {
    try {
      const obj = JSON.parse(reader.result);
      if (!obj || !Array.isArray(obj.clients)) throw new Error('Invalid file');

      const colRef = db.collection('users').doc(currentUser.uid).collection('clients');
      const batch = db.batch();

      // Delete existing clients
      const existing = await colRef.get();
      existing.forEach(doc => batch.delete(doc.ref));

      // Add imported clients
      obj.clients.forEach(c => {
        const copy = { ...c };
        delete copy.id;
        delete copy._index;
        delete copy._next;
        delete copy.justPaid;
        const newDocRef = colRef.doc(); // generate new doc id
        batch.set(newDocRef, copy);
      });

      // Commit all changes in one request
      await batch.commit();

      alert('Restore complete!');
    } catch (e) {
      console.error(e);
      alert('Could not restore ‚Äî invalid file.');
    }
  };
  reader.readAsText(file);
}

async function toggleDark(){
  const current = !!(currentProfile?.prefs?.darkMode);
  await savePrefs({ darkMode: !current });
  setTheme(!current);
}

async function saveTplClick(){
  const subj = $('#tplSubject').value;
  const body = $('#tplBody').value;
  await savePrefs({ tplSubject: subj, tplBody: body });
  alert('Template saved!');
}

/* ======== Forgot Password (via username -> email) ======== */
async function openForgot(){
  const username = prompt('Enter your username to send a reset email:');
  if(!username) return;
  try{
    const key = username.toLowerCase();
    const doc = await db.collection('usernames').doc(key).get();
    if(!doc.exists){ alert('No such username.'); return; }
    const { email } = doc.data();
    await auth.sendPasswordResetEmail(email);
    alert(`Password reset email sent to ${email}`);
  }catch(e){ console.error(e); alert('Could not send reset email.'); }
}

/* ======== UI Wiring ======== */
document.getElementById('createAccountBtn').addEventListener('click', ()=> {
  document.getElementById('registerModal').classList.add('open');
});
function closeModal(){ document.getElementById('registerModal').classList.remove('open'); }

$('#registerForm').addEventListener('submit', async e=>{
  e.preventDefault();
  await register($('#regUsername').value, $('#regEmail').value, $('#regPassword').value, $('#regQ').value, $('#regA').value);
  e.target.reset();
});
$('#loginForm').addEventListener('submit', async e=>{
  e.preventDefault();
  await login($('#loginUsername').value, $('#loginPassword').value);
});
$('#forgotBtn').addEventListener('click', openForgot);

$('#moreBtn').addEventListener('click', ()=> $('#moreMenu').classList.toggle('open'));
document.addEventListener('click', e=>{ if(!e.target.closest('.menu-wrap')) $('#moreMenu').classList.remove('open'); });
$('#exportExcel').addEventListener('click', exportToExcel);
$('#backupBtn').addEventListener('click', backupUser);
$('#restoreInput').addEventListener('change', e=>{ if(e.target.files?.[0]) restoreUser(e.target.files[0]); e.target.value=''; $('#moreMenu').classList.remove('open'); });
$('#darkToggle').addEventListener('click', toggleDark);
$('#logoutBtn').addEventListener('click', logout);

let searchTimeout;
$('#searchInput').addEventListener('input', function() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => { render(); }, 500);
});
$('#filterSelect').addEventListener('change', render);
$('#sortSelect').addEventListener('change', render);

$('#clientForm').addEventListener('submit', async e => {
  e.preventDefault();
  const name = $('#clientName').value.trim();
  const email = $('#clientEmail').value.trim();
  const phone = $('#clientPhone').value.trim();
  const address = $('#clientAddress').value.trim();
  const startDate = $('#startDate').value;
  const plan = $('#clientPlan').value.trim();
  if (!name || !startDate) return;

  // No duplicates check across devices here; Firestore rules or extra query can enforce if you want strict uniqueness.
  await addClient({ name, email, phone, address, startDate, plan, notes: '' });
  e.target.reset();
});

$('#saveTpl').addEventListener('click', saveTplClick);

/* ======== Simple dialog helpers (kept) ======== */
function showDialog(title, bodyNode, onOk, okLabel='OK', cancelLabel='Cancel'){
  $('#dialogTitle').textContent = title;
  const body = $('#dialogBody'); body.innerHTML=''; if(bodyNode) body.appendChild(bodyNode);
  $('#dialogBackdrop').classList.add('open');
  $('#dialogOk').textContent = okLabel; $('#dialogCancel').textContent = cancelLabel;
  const okHandler = async ()=>{ if(typeof onOk === 'function'){ const res = await onOk(); if(res === false) return; } closeDialog(); };
  $('#dialogOk').onclick = okHandler;
  $('#dialogCancel').onclick = closeDialog;
}
function closeDialog(){ $('#dialogBackdrop').classList.remove('open'); }
</script>
</body>
</html>
