<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>Client List Reminders — Improved</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

  <style>
    :root {
      --bg: #f6f7fb; --card: #fff; --text: #0f172a; --muted: #64748b;
      --primary: #008CBA; --primary-contrast: #fff; --accent: #22c55e;
      --warn: #f59e0b; --danger: #ef4444; --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(2,6,23,0.08); --radius:14px; --pad:14px;
      --focus: 0 0 0 3px rgba(59,130,246,.45);
    }
    [data-theme="dark"] {
      --bg:#0b1220; --card:#111a2c; --text:#e5e7eb; --muted:#9aa7bd;
      --primary:#3b82f6; --primary-contrast:#0b1220; --accent:#22c55e;
      --warn:#fbbf24; --danger:#ef4444; --border:#1f2a44; --shadow:0 10px 30px rgba(0,0,0,.5);
      --focus: 0 0 0 3px rgba(59,130,246,.55);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{margin:0;padding:16px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;line-height:1.45;}
    .container{max-width:1100px;margin:0 auto;}
    h1,h2,h3{margin:0 0 10px;}
    .muted{color:var(--muted);}    
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:calc(var(--pad)*1.2);}    
    .row{display:grid;gap:10px;}
    .topbar{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;margin-bottom:14px;}
    .brand{font-weight:800;letter-spacing:.3px;}
    .btn,button{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);cursor:pointer;transition: transform .06s ease, background .2s ease, border-color .2s ease;}
    .btn:hover{transform:translateY(-1px);}    
    .btn:focus-visible{outline:none;box-shadow:var(--focus);}    
    .btn.primary{background:var(--primary);color:var(--primary-contrast);border-color:transparent;}
    .btn.success{background:var(--accent);color:#fff;border-color:transparent;}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent;}
    .btn.ghost{background:transparent;}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);outline:none;}
    textarea{min-height:70px;resize:vertical;}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:var(--focus);}    
    .menu-wrap{position:relative;}
    .menu{position:absolute;top:calc(100% + 6px);right:0;min-width:260px;z-index:10;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:8px;display:none;}
    .menu.open{display:block;}
    .menu .item{padding:10px;border-radius:10px;cursor:pointer;}
    .menu .item:hover{background: rgba(100,116,139,.16);}    
    .hide{display:none !important;}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin:14px 0 8px;font-weight:700;}
    .list{display:grid;gap:8px;}
    .client{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-left:6px solid var(--primary);border-radius:12px;padding:12px;background:var(--card);}    
    .client.overdue{border-left-color: var(--danger);background: rgba(239,68,68,.08);}    
    .client.today{border-left-color: var(--warn);background: rgba(245,158,11,.10);}    
    .client.paid{border-left-color: var(--accent);background: rgba(34,197,94,.10);}    
    .info{display:grid;gap:6px;}
    @media (min-width:900px){.info{grid-template-columns:1.2fr 1fr 1fr 1fr;}}
    details summary{cursor:pointer;user-select:none;}
    .label{font-size:.78rem;color:var(--muted);}    
    .value{font-weight:600;}
    .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;}
    .dialog-backdrop.open{display:flex;}
    .dialog{max-width:520px;width:100%;}
    .dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}

    @media(max-width:600px){
      .client{padding:10px;font-size:14px;}
      .btn{width:100%;padding:15px;}
    }
    @media(min-width:601px) and (max-width:1024px){
      .client{padding:15px;font-size:16px;}
      .btn{width:auto;}
    }

    /* small action buttons for client cards */
    .client .actions .btn { padding: 6px 8px; font-size: 0.85rem; }
    @media(max-width:600px){ .client .actions .btn { padding: 4px 6px; font-size: 0.75rem; } }
    @media(min-width:601px) and (max-width:900px){ .client .actions .btn { padding: 5px 7px; font-size: 0.8rem; } }
    @media(min-width:901px){ .client .actions .btn { padding: 6px 10px; font-size: 0.9rem; } }

    .spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:20px auto;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    /* Fix calendar button dark mode issue */
    input[type="date"] { color-scheme: light !important; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

    /* Make client info readable on small screens */
    @media (max-width: 600px) {
      .client .info { display: block; }
      .client .info > div { margin-bottom: 10px; }
      .client .label { font-size: 14px; display: block; margin-bottom: 2px; }
      .client .value, .client .inp { font-size: 16px; width: 100%; }
      .client { font-size: 14px; padding: 12px; }
      .client .actions { flex-direction: column; gap: 6px; }
    }

    /* utility spacing */
    .mb-12 { margin-bottom: 12px; }
    .center { text-align: center; }

    /* stacked fields for the Add Client form */
    .field { display: flex; flex-direction: column; gap: 6px; }
    .form-actions-right { display:flex; gap:8px; justify-content:flex-end; }

    /* footer */
    footer { margin-top: 28px; text-align: center; color: var(--muted); font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="loginView">
      <div class="card" style="max-width:520px;margin:8vh auto;">
        <h1 class="center">Client List Reminders</h1>
        <p class="muted center" style="margin-bottom:14px;">v.04 (improved)</p>
        <div class="row" style="gap:14px;">
          <div class="card">
            <h3>Login</h3>
            <form id="loginForm" class="row" style="gap:10px;margin-top:8px;">
              <input id="loginEmail" type="email" placeholder="Email" autocomplete="username" required />
              <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" required />
              <button class="btn primary" type="submit">Login</button>
              <button id="forgotBtn" class="btn ghost" type="button">Forgot Password?</button>
            </form>
          </div>
          <div class="card">
            <h3>Create Account</h3>
            <button id="createAccountBtn" class="btn success" type="button">Create Account</button>
            <p class="muted" style="margin-top:6px;">Make our client satisfied</p>
          </div>
        </div>
      </div>
    </div>

    <div id="loadingSpinner" class="spinner" style="display:none;"></div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="dialog-backdrop" aria-hidden="true">
    <div class="dialog card" role="dialog" aria-modal="true" aria-labelledby="registerTitle">
      <h3 id="registerTitle">Create Account</h3>
      <form id="registerForm" class="row" style="gap:10px;">
        <input id="regEmail" type="email" placeholder="Email (used for login & reset)" required />
        <input id="regPassword" type="password" placeholder="Password" minlength="6" required />
        <div class="actions">
          <button class="btn success" type="submit">Create Account</button>
          <button class="btn ghost" type="button" data-close-modal="#registerModal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div id="forgotModal" class="dialog-backdrop" aria-hidden="true">
    <div class="dialog card" role="dialog" aria-modal="true" aria-labelledby="forgotTitle">
      <h3 id="forgotTitle">Forgot Password</h3>
      <div class="row" style="gap:10px;">
        <input id="forgotEmail" type="email" placeholder="Enter your email" />
      </div>
      <div class="actions">
        <button class="btn" type="button" data-close-modal="#forgotModal">Cancel</button>
        <button id="forgotSend" class="btn primary" type="button">Send Reset Email</button>
      </div>
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="appView" class="hide">
    <!-- Topbar & Menu -->
    <div class="topbar">
      <div class="brand">📒 Client List Reminders</div>
      <div class="muted" id="whoami" aria-live="polite"></div>
      <div class="menu-wrap">
        <button id="moreBtn" class="btn" aria-haspopup="true" aria-expanded="false" aria-label="Open menu">☰ Menu</button>
        <div id="moreMenu" class="menu" role="menu" aria-hidden="true">
          <div class="item" id="exportExcel">📥 Export to Excel</div>
          <div class="item" id="backupBtn">💾 Backup (download .json)</div>
          <label class="item" for="restoreInput" style="display:block;cursor:pointer;">📤 Restore (upload .json)</label>
          <input id="restoreInput" type="file" accept=".json,application/json" class="hide" />
          <div class="item" id="darkToggle">🌓 Toggle Dark</div>
          <div class="item muted" style="cursor:default;">Dark mode is enabled by default.</div>
          <div class="item" id="logoutBtn">🚪 Logout</div>
        </div>
      </div>
    </div>

    <!-- Settings & Email Template -->
    <div class="card mb-12">
      <details>
        <summary><strong>✉️ Email Reminder Template</strong> <span class="muted">(per user)</span></summary>
        <div class="row" style="margin-top:10px;grid-template-columns:1fr;">
          <input id="tplSubject" type="text" placeholder="Subject (e.g., Payment Reminder for {{name}})" />
          <textarea id="tplBody" placeholder="Body. Use {{name}}, {{next}}, {{plan}} tokens."></textarea>
          <button id="saveTpl" class="btn">Save Template</button>
          <p class="muted">Your registered email will be used as the sender by your email app.</p>
        </div>
      </details>
    </div>

    <!-- Add Client -->
    <div class="card mb-12" id="addClientCard">
      <div class="row" style="grid-template-columns:1fr auto; align-items:center;">
        <h3 style="margin:0;">Add Client</h3>
        <button id="toggleAddForm" class="btn primary" type="button" aria-controls="clientForm" aria-expanded="false">+ Add Client</button>
      </div>
      <form id="clientForm" class="row hide" style="margin-top:10px; grid-template-columns:1fr;">
        <div class="field">
          <label class="label" for="clientName">Client name</label>
          <input type="text" id="clientName" placeholder="e.g., James Doe" required />
        </div>
        <div class="field">
          <label class="label" for="clientEmail">Client email</label>
          <input type="email" id="clientEmail" placeholder="e.g., jamesfloyd@example.com" />
        </div>
        <div class="field">
          <label class="label" for="clientPhone">Contact no.</label>
          <input type="tel" id="clientPhone" inputmode="tel" pattern="^[0-9+()\-\s]{7,}$" placeholder="e.g., 09456789102" />
        </div>
        <div class="field">
          <label class="label" for="clientAddress">Address</label>
          <input type="text" id="clientAddress" placeholder="e.g., 123 Main St" />
        </div>
        <div class="field">
          <label class="label" for="startDate">Date</label>
          <input type="date" id="startDate" required />
        </div>
        <div class="field">
          <label class="label" for="clientPlan">Plan</label>
          <input type="text" id="clientPlan" placeholder="e.g., $50 (you can also add text here)" required />
        </div>
        <div class="form-actions-right">
          <button id="cancelAdd" class="btn" type="button">Cancel</button>
          <button class="btn primary" type="submit">Add</button>
        </div>
      </form>
    </div>

    <!-- Filters -->
    <div class="card mb-12">
      <div class="row" style="grid-template-columns: 2fr 1fr 1fr;">
        <input id="searchInput" type="text" placeholder="Search by client name…" />
        <select id="filterSelect">
          <option value="all">All</option>
          <option value="due-month">Due this month</option>
          <option value="overdue">Overdue</option>
          <option value="upcoming">Upcoming (later)</option>
        </select>
        <select id="sortSelect">
          <option value="name-asc">Sort: Name ↑</option>
          <option value="name-desc">Sort: Name ↓</option>
          <option value="date-asc">Sort: Next payment ↑</option>
          <option value="date-desc">Sort: Next payment ↓</option>
          <option value="plan-asc">Sort: Plan ↑</option>
          <option value="plan-desc">Sort: Plan ↓</option>
        </select>
      </div>
    </div>

    <!-- Lists -->
    <div>
      <div class="section-title">
        <span>📅 This Month</span>
        <span class="muted" id="countThisMonth">0</span>
      </div>
      <div id="dueList" class="list"></div>

      <div class="section-title" style="margin-top:18px;">
        <span>✅ Paid / Later</span>
        <span class="muted" id="countLater">0</span>
      </div>
      <div id="paidList" class="list"></div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>© 2025 Client Manager. All Rights Reserved.</footer>

  <!-- Generic Dialog -->
  <div id="dialogBackdrop" class="dialog-backdrop" aria-hidden="true">
    <div class="dialog card" role="dialog" aria-modal="true" aria-labelledby="dialogTitle">
      <h3 id="dialogTitle">Dialog</h3>
      <div id="dialogBody" class="row"></div>
      <div class="actions">
        <button id="dialogCancel" class="btn">Cancel</button>
        <button id="dialogOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- APP SCRIPT (Firebase Modular) -->
  <script type="module">
    // ===================== Firebase Modular SDK =====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, deleteDoc,
      onSnapshot, serverTimestamp, writeBatch, query, orderBy, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

    // ---- Config ----
    const firebaseConfig = {
      apiKey: "AIzaSyD8KyIuPpW4w9vwEwfzemhxYYp2nJy4Io8",
      authDomain: "client-management-f6060.firebaseapp.com",
      projectId: "client-management-f6060",
      storageBucket: "client-management-f6060.appspot.com",
      messagingSenderId: "267148533200",
      appId: "1:267148533200:web:59f74ba662122c81c22dd5",
      measurementId: "G-M6QEGME5SZ"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    try { if (await isSupported()) getAnalytics(app); } catch(_) {}
    try { await enableIndexedDbPersistence(db); } catch(_) {}

    // ===================== Utils & State =====================
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const today0 = () => { const d = new Date(); d.setHours(0,0,0,0); return d; };
    const toYMD = d => d.toISOString().split('T')[0];
    function formatDate(d){ return toYMD(d); }
    function setTheme(d){ document.documentElement.setAttribute('data-theme', d?'dark':'light'); }
    function escapeHtml(s=''){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}
    function escapeAttr(s=''){return escapeHtml(s)}
    function showSpinner(show){ $('#loadingSpinner').style.display = show ? 'block' : 'none'; }

    // Friendly auth error mapping
    function mapAuthError(err){
      const code = err?.code || '';
      const map = {
        'auth/email-already-in-use':'That email is already registered.',
        'auth/invalid-email':'Please enter a valid email address.',
        'auth/weak-password':'Password should be at least 6 characters.',
        'auth/user-not-found':'No account found with that email.',
        'auth/wrong-password':'Incorrect password. Try again.',
        'auth/too-many-requests':'Too many attempts. Please try later.'
      };
      return map[code] || 'Something went wrong. Please try again.';
    }

    // Advance to the next payment date >= today (handles long overdue)
    function nextPaymentFrom(startDate){
      const now = today0();
      const next = new Date(startDate);
      next.setHours(0,0,0,0);
      if (isNaN(next)) return now; // fallback
      if (next >= now) return next;
      const yDiff = now.getFullYear() - next.getFullYear();
      const mDiff = now.getMonth() - next.getMonth();
      let months = yDiff * 12 + mDiff;
      if (now.getDate() > next.getDate()) months += 1;
      next.setMonth(next.getMonth() + months);
      while (next < now) next.setMonth(next.getMonth() + 1);
      return next;
    }
    function isToday(dateObj){ const t=today0().getTime(); const d=new Date(dateObj); d.setHours(0,0,0,0); return d.getTime()===t; }
    function isThisMonth(dateObj){ const t=today0(); return dateObj.getMonth()===t.getMonth() && dateObj.getFullYear()===t.getFullYear(); }
    function isOverdue(dateObj){ const now=today0(); const d=new Date(dateObj); d.setHours(0,0,0,0); return d<now; }

    let currentUser = null;        // Firebase User
    let currentProfile = null;     // {email, prefs...}
    let clientsCache = [];         // [{id, ...}]
    let unsubClients = null;

    // ===================== Auth & Profiles =====================
    async function register(email, password){
      email = (email||'').trim();
      if(!email || !password) return alert('Please fill email and password.');
      showSpinner(true);
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;
        const profile = {
          email,
          createdAt: serverTimestamp(),
          prefs: {
            darkMode:false,
            tplSubject:'Payment Reminder for {{name}}',
            tplBody:'Hello {{name}},\n\nYour next payment is due on {{next}} for {{plan}}.\n\nThank you.'
          }
        };
        await setDoc(doc(db, 'users', uid), profile);
        alert('Account created! You can now login.');
        closeModal('#registerModal');
      } catch(err){
        console.error(err);
        alert(mapAuthError(err));
      } finally {
        showSpinner(false);
      }
    }

    async function login(email, password){
      email = (email||'').trim();
      if(!email || !password) return;
      showSpinner(true);
      try{
        await signInWithEmailAndPassword(auth, email, password);
      } catch(err){
        console.error(err);
        alert(mapAuthError(err));
      } finally {
        showSpinner(false);
      }
    }

    function logout(){
      if(unsubClients) { unsubClients(); unsubClients = null; }
      clientsCache = [];
      currentProfile = null;
      signOut(auth);
      setTheme(true);
      $('#appView').classList.add('hide');
      $('#loginView').classList.remove('hide');
      $('#loginForm').reset();
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        $('#whoami').textContent = '';
        setTheme(true);
        $('#loginView').classList.remove('hide');
        $('#appView').classList.add('hide');
        return;
      }
      currentUser = user;

      const profSnap = await getDoc(doc(db, 'users', user.uid));
      currentProfile = profSnap.exists() ? profSnap.data() : { email: user.email, prefs:{} };

      const hasPref = currentProfile?.prefs && ('darkMode' in currentProfile.prefs);
      setTheme(hasPref ? !!currentProfile.prefs.darkMode : true);

      $('#whoami').textContent = currentProfile.email || user.email || '';

      const p = currentProfile.prefs || {};
      $('#tplSubject').value = p.tplSubject || 'Payment Reminder for {{name}}';
      $('#tplBody').value    = p.tplBody || 'Hello {{name}},\n\nYour next payment is due on {{next}} for {{plan}}.\n\nThank you.';

      if(unsubClients) unsubClients();
      const qClients = query(collection(db, 'users', user.uid, 'clients'), orderBy('name'));
      unsubClients = onSnapshot(qClients, (snap)=>{
        clientsCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        render();
      });

      $('#loginView').classList.add('hide');
      $('#appView').classList.remove('hide');
    });

    // ===================== Firestore CRUD =====================
    function getClients(){ return clientsCache || []; }
    function statusFor(c){
      const next = nextPaymentFrom(new Date(c.startDate));
      if (isToday(next)) return 'Due Today';
      if (isThisMonth(next)) return 'Due This Month';
      return 'Paid for Next Month';
    }

    async function addClient(c){
      if(!currentUser) return;
      await addDoc(collection(db, 'users', currentUser.uid, 'clients'), c);
    }
    async function updateClient(id, patch){
      if(!currentUser || !id) return;
      await updateDoc(doc(db, 'users', currentUser.uid, 'clients', id), patch);
    }
    async function deleteClient(id){
      if(!currentUser || !id) return;
      await deleteDoc(doc(db, 'users', currentUser.uid, 'clients', id));
    }
    async function savePrefs(patch){
      if(!currentUser) return;
      const next = { ...(currentProfile||{}), prefs: { ...(currentProfile?.prefs||{}), ...patch } };
      await updateDoc(doc(db, 'users', currentUser.uid), { prefs: next.prefs });
      currentProfile = next;
    }

    // ===================== Render (fast path with fragment) =====================
    function render(){
      const dueWrap = $('#dueList'), paidWrap = $('#paidList');
      dueWrap.innerHTML=''; paidWrap.innerHTML='';

      let list = getClients().map((c,i)=>({ ...c, _index:i, _next: nextPaymentFrom(new Date(c.startDate)) }));

      const qstr = $('#searchInput').value.trim().toLowerCase();
      if(qstr) list = list.filter(c => (c.name||'').toLowerCase().includes(qstr));

      const filt = $('#filterSelect').value;
      if(filt==='due-month') list = list.filter(c => isThisMonth(c._next));
      if(filt==='overdue') list = list.filter(c => isOverdue(c._next));
      if(filt==='upcoming') list = list.filter(c => !isThisMonth(c._next) && !isOverdue(c._next));

      const sort = $('#sortSelect').value;
      const n = v => (parseFloat((v||'').replace(/[^0-9.]/g,''))||0);
      const cmp = {
        'name-asc': (a,b)=>(a.name||'').localeCompare(b.name||''),
        'name-desc':(a,b)=>(b.name||'').localeCompare(a.name||''),
        'date-asc': (a,b)=> a._next - b._next,
        'date-desc':(a,b)=> b._next - a._next,
        'plan-asc': (a,b)=> n(a.plan) - n(b.plan),
        'plan-desc':(a,b)=> n(b.plan) - n(a.plan),
      }[sort] || ((a,b)=>0);
      list.sort(cmp);

      let countThis=0, countLater=0;
      const dueFrag = document.createDocumentFragment();
      const paidFrag = document.createDocumentFragment();

      list.forEach(c=>{
        const nextStr = formatDate(c._next);
        const dueToday = isToday(c._next);
        const inThisMonth = isThisMonth(c._next);
        const overdue = isOverdue(new Date(c._next.getTime()-86400000));

        const card = document.createElement('div');
        card.className = 'client';
        if (c.justPaid) card.classList.add('paid');
        if (dueToday) card.classList.add('today');
        if (overdue) card.classList.add('overdue');
        card.dataset.i = String(c._index);

        const details = `
          <details>
            <summary class="muted">More info</summary>
            <div class="row" style="margin-top:8px; grid-template-columns: 1fr 1fr;">
              <label class="label">Email</label><input class="inp email" data-i="${c._index}" type="email" value="${escapeAttr(c.email||'')}"/>
              <label class="label">Phone</label><input class="inp phone" data-i="${c._index}" type="text" value="${escapeAttr(c.phone||'')}"/>
              <label class="label">Address</label><input class="inp addr" data-i="${c._index}" type="text" value="${escapeAttr(c.address||'')}"/>
              <label class="label">Notes</label><textarea class="inp notes" data-i="${c._index}">${escapeHtml(c.notes||'')}</textarea>
            </div>
          </details>`;

        card.innerHTML = `
          <div class="info">
            <div><div class="label">Name</div><div class="value">${escapeHtml(c.name||'')}</div></div>
            <div><div class="label">Plan</div><div><input class="inp plan" data-i="${c._index}" type="text" value="${escapeAttr(c.plan||'')}" /></div></div>
            <div><div class="label">Start Date</div><div><input class="inp date" data-i="${c._index}" type="date" value="${escapeAttr(c.startDate||'')}" /></div></div>
            <div><div class="label">Next Payment</div><div class="value">${dueToday?'🟧 Today':nextStr}</div></div>
          </div>
          <div class="actions" style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn success" data-action="paid" data-i="${c._index}">✅ Mark Paid</button>
            <button class="btn" data-action="email" data-i="${c._index}">✉️ Email</button>
            <button class="btn danger" data-action="del" data-i="${c._index}">🗑️ Delete</button>
          </div>
          ${details}
        `;
        if(inThisMonth){ dueFrag.appendChild(card); countThis++; } else { paidFrag.appendChild(card); countLater++; }
      });
      dueWrap.appendChild(dueFrag);
      paidWrap.appendChild(paidFrag);
      $('#countThisMonth').textContent = countThis;
      $('#countLater').textContent = countLater;
    }

    // ===================== Handlers (Event Delegation) =====================
    async function onMarkPaid(i){
      const item = getClients()[i]; if(!item) return;
      if(!confirm('Mark as paid and move next payment to the next future month?')) return;
      let d = new Date(item.startDate); d.setHours(0,0,0,0);
      // Roll forward until next >= today
      const today = today0();
      do { d.setMonth(d.getMonth()+1); } while (d < today);
      await updateClient(item.id, { startDate: formatDate(d) });
    }
    async function onDelete(i){
      const item = getClients()[i]; if(!item) return;
      if (!confirm(`Delete ${item.name || 'this client'}? This cannot be undone.`)) return;
      await deleteClient(item.id);
    }

    // Debounced field update to reduce rapid writes
    const debouncers = new Map();
    function debounceKey(key, fn, ms=400){
      clearTimeout(debouncers.get(key));
      const t = setTimeout(fn, ms);
      debouncers.set(key, t);
    }

    async function onEdit(i, field, value){
      const item = getClients()[i]; if(!item) return;
      const key = `${item.id}:${field}`;
      debounceKey(key, () => updateClient(item.id, { [field]: value }), 450);
    }
  function onEmail(i){
  console.log('[onEmail] clicked index=', i);
  const c = getClients()[i];
  console.log('[onEmail] client:', c);
  if (!c) {
    // unexpected — provide feedback
    showDialog('Error', document.createTextNode('Client not found.'));
    return;
  }

  // If no email -> show popup and stop
  if (!c.email || String(c.email).trim() === '') {
    // use your app dialog (nicer) so it looks consistent with the UI
    showDialog('No email', document.createTextNode('No email added for this client.'));
    return;
  }

  const next = formatDate(nextPaymentFrom(new Date(c.startDate)));
  const p = currentProfile?.prefs || {};

  const subject = encodeURIComponent((p.tplSubject || 'Payment Reminder for {{name}}')
    .replace(/{{name}}/g, c.name||'')
    .replace(/{{next}}/g, next)
    .replace(/{{plan}}/g, c.plan||''));

  const body = encodeURIComponent((p.tplBody || 'Hello {{name}},\n\nYour next payment is due on {{next}} for {{plan}}.\n\nThank you.')
    .replace(/{{name}}/g, c.name||'')
    .replace(/{{next}}/g, next)
    .replace(/{{plan}}/g, c.plan||''));

  const to = encodeURIComponent(c.email);
  const footer = `%0D%0A%0D%0ASent from: ${encodeURIComponent(auth.currentUser?.email||'')}`;

  // Detect if running on mobile
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  if (isMobile) {
    // Mobile → open default mail app
    location.href = `mailto:${to}?subject=${subject}&body=${body}${footer}`;
  } else {
    // Desktop → force Gmail web
    const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${to}&su=${subject}&body=${body}${footer}`;
    window.open(gmailUrl, "_blank");
  }
}


    function exportToExcel(){
      const list = getClients().map(c=>({ ...c, _next: nextPaymentFrom(new Date(c.startDate)) }));
      const order = { 'Due Today':0, 'Due This Month':1, 'Paid for Next Month':2 };
      list.sort((a,b)=> (order[statusFor(a)] - order[statusFor(b)]) || (a._next - b._next));
      const data = list.map(c=>({
        "Client Name": c.name, "Email": c.email || '', "Phone": c.phone || '',
        "Address": c.address || '', "Plan": c.plan || '', "Start Date": c.startDate,
        "Next Payment": formatDate(c._next), "Status": statusFor(c), "Notes": c.notes || ''
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Clients");
      const base = (currentUser?.email?.split('@')[0]) || 'user';
      XLSX.writeFile(wb, `${base}_Clients.xlsx`);
    }
    function download(filename, text){
      const blob = new Blob([text], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }
    function backupUser(){
      const payload = { email: currentUser?.email || '', clients: getClients() };
      const base = (currentUser?.email?.split('@')[0]) || 'user';
      download(`${base}_backup.json`, JSON.stringify(payload,null,2));
    }

    // Strict validator for restore payload
    function validateClient(c){
      const errors = [];
      if(!c || typeof c !== 'object') { errors.push('Invalid entry'); return errors; }
      if(!c.name || typeof c.name !== 'string') errors.push('Missing name');
      if(!c.startDate || !/^\d{4}-\d{2}-\d{2}$/.test(c.startDate)) errors.push('Invalid startDate');
      if(c.email && typeof c.email !== 'string') errors.push('Invalid email');
      if(c.phone && typeof c.phone !== 'string') errors.push('Invalid phone');
      if(c.address && typeof c.address !== 'string') errors.push('Invalid address');
      if(c.plan && typeof c.plan !== 'string') errors.push('Invalid plan');
      if(c.notes && typeof c.notes !== 'string') errors.push('Invalid notes');
      return errors;
    }

    async function restoreUser(file) {
      if (!currentUser) return;
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const obj = JSON.parse(reader.result);
          if (!obj || !Array.isArray(obj.clients)) throw new Error('Invalid file: missing clients array');

          // Validate first
          const problems = [];
          const clean = obj.clients.map((c,idx)=>{
            const copy = { ...c };
            delete copy.id; delete copy._index; delete copy._next; delete copy.justPaid;
            const errs = validateClient(copy);
            if (errs.length) problems.push(`Row ${idx+1}: ${errs.join(', ')}`);
            return copy;
          });
          if (problems.length) throw new Error('Validation errors:\n' + problems.join('\n'));

          const colRefPath = ['users', currentUser.uid, 'clients'];
          const batch = writeBatch(db);
          clientsCache.forEach(c => batch.delete(doc(db, ...colRefPath, c.id)));
          clean.forEach(c => { const ref = doc(collection(db, ...colRefPath)); batch.set(ref, c); });
          await batch.commit();
          alert('Restore complete!');
        } catch (e) {
          console.error(e);
          alert(String(e.message || e) || 'Could not restore — invalid file.');
        }
      };
      reader.readAsText(file);
    }

    async function toggleDark(){
      const current = !!(currentProfile?.prefs?.darkMode);
      await savePrefs({ darkMode: !current });
      setTheme(!current);
    }
    async function saveTplClick(){
      const subj = $('#tplSubject').value;
      const body = $('#tplBody').value;
      await savePrefs({ tplSubject: subj, tplBody: body });
      alert('Template saved!');
    }

    // ===================== Simple dialog helpers =====================
    function showDialog(title, bodyNode, onOk, okLabel='OK', cancelLabel='Cancel'){
      $('#dialogTitle').textContent = title;
      const body = $('#dialogBody'); body.innerHTML=''; if(bodyNode) body.appendChild(bodyNode);
      trapOpen('#dialogBackdrop');
      $('#dialogOk').textContent = okLabel; $('#dialogCancel').textContent = cancelLabel;
      const okHandler = async ()=>{ if(typeof onOk === 'function'){ const res = await onOk(); if(res === false) return; } trapClose('#dialogBackdrop'); };
      $('#dialogOk').onclick = okHandler;
      $('#dialogCancel').onclick = ()=> trapClose('#dialogBackdrop');
    }

    // ===================== Modal accessibility (focus trap) =====================
    let lastActive = null;
    function trapOpen(sel){
      const el = document.querySelector(sel);
      if (!el) return;
      lastActive = document.activeElement;
      el.classList.add('open');
      el.setAttribute('aria-hidden','false');
      const focusable = el.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      (focusable||el).focus();
      function onKey(e){
        if(e.key==='Escape'){ trapClose(sel); }
        if(e.key==='Tab'){
          const nodes = el.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          const list = Array.from(nodes).filter(n=>!n.hasAttribute('disabled'));
          if(!list.length) return;
          const first=list[0], last=list[list.length-1];
          if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
          else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
        }
      }
      el._trapHandler = onKey; document.addEventListener('keydown', onKey);
    }
    function trapClose(sel){
      const el = document.querySelector(sel); if(!el) return;
      el.classList.remove('open');
      el.setAttribute('aria-hidden','true');
      document.removeEventListener('keydown', el._trapHandler); delete el._trapHandler;
      if(lastActive && lastActive.focus) lastActive.focus();
    }
    function openModal(sel){ trapOpen(sel); }
    function closeModal(sel){ trapClose(sel); }
    window.closeModal = closeModal;

    // ===================== UI Wiring =====================
    $('#createAccountBtn').addEventListener('click', ()=> openModal('#registerModal'));
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-close-modal]');
      if (btn){ closeModal(btn.getAttribute('data-close-modal')); }
    });

    $('#registerForm').addEventListener('submit', async e=>{
      e.preventDefault();
      await register($('#regEmail').value, $('#regPassword').value);
      e.target.reset();
    });
    $('#loginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      await login($('#loginEmail').value, $('#loginPassword').value);
    });

    // Forgot password
    $('#forgotBtn').addEventListener('click', ()=> openModal('#forgotModal'));
    $('#forgotSend').addEventListener('click', async ()=>{
      const email = $('#forgotEmail').value.trim();
      if(!email) return alert('Please enter your email.');
      try{
        await sendPasswordResetEmail(auth, email);
        alert(`Password reset email sent to ${email}`);
        closeModal('#forgotModal');
      }catch(e){ console.error(e); alert(mapAuthError(e)); }
    });

    // Menu & misc
    $('#moreBtn').addEventListener('click', ()=>{
      const menu = $('#moreMenu');
      const isOpen = menu.classList.toggle('open');
      $('#moreBtn').setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      menu.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    });
    document.addEventListener('click', e=>{ if(!e.target.closest('.menu-wrap')) $('#moreMenu').classList.remove('open'); });
    $('#exportExcel').addEventListener('click', exportToExcel);
    $('#backupBtn').addEventListener('click', backupUser);
    $('#restoreInput').addEventListener('change', e=>{ if(e.target.files?.[0]) restoreUser(e.target.files[0]); e.target.value=''; $('#moreMenu').classList.remove('open'); });
    $('#darkToggle').addEventListener('click', toggleDark);
    $('#logoutBtn').addEventListener('click', logout);

    // Filters & search (debounced)
    let searchTimeout;
    $('#searchInput').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => { render(); }, 300);
    });
    $('#filterSelect').addEventListener('change', render);
    $('#sortSelect').addEventListener('change', render);

    // Add Client show/hide logic + submit
    const addForm = $('#clientForm');
    const toggleAddBtn = $('#toggleAddForm');
    const cancelAddBtn = $('#cancelAdd');

    toggleAddBtn.addEventListener('click', ()=>{
      const hidden = addForm.classList.toggle('hide');
      toggleAddBtn.setAttribute('aria-expanded', hidden ? 'false':'true');
      if(!hidden){ $('#clientName').focus(); }
    });
    cancelAddBtn.addEventListener('click', ()=>{
      addForm.reset();
      addForm.classList.add('hide');
      toggleAddBtn.setAttribute('aria-expanded','false');
      toggleAddBtn.focus();
    });

    addForm.addEventListener('submit', async e => {
      e.preventDefault();
      const name = $('#clientName').value.trim();
      const email = $('#clientEmail').value.trim();
      const phone = $('#clientPhone').value.trim();
      const address = $('#clientAddress').value.trim();
      const startDate = $('#startDate').value;
      const plan = $('#clientPlan').value.trim();
      if (!name || !startDate) return alert('Please fill Name and Date.');
      await addClient({ name, email, phone, address, startDate, plan, notes: '' });
      addForm.reset();
      addForm.classList.add('hide');
      toggleAddBtn.setAttribute('aria-expanded','false');
    });

    // Event delegation for lists (clicks)
    document.addEventListener('click', async (e)=>{
      const actionBtn = e.target.closest('.client .actions .btn');
      if (actionBtn){
        const i = +actionBtn.dataset.i;
        const action = actionBtn.dataset.action;
        if (action === 'paid') return onMarkPaid(i);
        if (action === 'del') return onDelete(i);
        if (action === 'email') return onEmail(i);
      }
    });

    // Event delegation for inputs
    document.addEventListener('change', async (e)=>{
      const inp = e.target;
      if (inp.matches('.inp.date')){
        const i = +inp.dataset.i;
        await onEdit(i, 'startDate', inp.value);
      }
    });
    document.addEventListener('blur', async (e)=>{
      const inp = e.target;
      if (!(inp instanceof HTMLElement)) return;
      if (inp.matches('.inp.plan')) { const i = +inp.dataset.i; onEdit(i, 'plan', inp.value); }
      if (inp.matches('.inp.email')){ const i = +inp.dataset.i; onEdit(i, 'email', inp.value); }
      if (inp.matches('.inp.phone')){ const i = +inp.dataset.i; onEdit(i, 'phone', inp.value); }
      if (inp.matches('.inp.addr')) { const i = +inp.dataset.i; onEdit(i, 'address', inp.value); }
      if (inp.matches('.inp.notes')){ const i = +inp.dataset.i; onEdit(i, 'notes', inp.value); }
    }, true);

    // Save template
    $('#saveTpl').addEventListener('click', saveTplClick);

    // ===================== Firestore Rules (reference) =====================
    /*
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /users/{userId} {
          allow read, update, delete: if request.auth != null && request.auth.uid == userId;
          allow create: if request.auth != null && request.auth.uid == userId;
          match /clients/{clientId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
          }
        }
      }
    }
    */
  </script>
</body>
</html>
