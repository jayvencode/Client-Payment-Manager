<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client List Reminders — User</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

  <style>
    :root {
      --bg: #f6f7fb; --card: #fff; --text: #0f172a; --muted: #64748b;
      --primary: #008CBA; --primary-contrast: #fff; --accent: #22c55e;
      --warn: #f59e0b; --danger: #ef4444; --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(2,6,23,0.08); --radius:14px; --pad:14px;
    }
    [data-theme="dark"] {
      --bg:#0b1220; --card:#111a2c; --text:#e5e7eb; --muted:#9aa7bd;
      --primary:#3b82f6; --primary-contrast:#0b1220; --accent:#22c55e;
      --warn:#fbbf24; --danger:#ef4444; --border:#1f2a44; --shadow:0 10px 30px rgba(0,0,0,.5);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{margin:0;padding:16px;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial;line-height:1.45;}
    .container{max-width:1100px;margin:0 auto;}
    h1,h2,h3{margin:0 0 10px;}
    .muted{color:var(--muted);}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:calc(var(--pad)*1.2);}
    .row{display:grid;gap:10px;}
    .topbar{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;margin-bottom:14px;}
    .brand{font-weight:800;letter-spacing:.3px;}
    .btn,button{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);cursor:pointer;transition: transform .06s ease, background .2s ease, border-color .2s ease;}
    .btn:hover{transform:translateY(-1px);}
    .btn.primary{background:var(--primary);color:var(--primary-contrast);border-color:transparent;}
    .btn.success{background:var(--accent);color:#fff;border-color:transparent;}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent;}
    .btn.ghost{background:transparent;}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);outline:none;}
    textarea{min-height:70px;resize:vertical;}
    input:focus,select:focus,textarea:focus{border-color:var(--primary);}
    .menu-wrap{position:relative;}
    .menu{position:absolute;top:calc(100%+6px);right:0;min-width:260px;z-index:10;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:8px;display:none;}
    .menu.open{display:block;}
    .menu .item{padding:10px;border-radius:10px;cursor:pointer;}
    .menu .item:hover{background: rgba(100,116,139,.16);}
    .hide{display:none !important;}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin:14px 0 8px;font-weight:700;}
    .list{display:grid;gap:8px;}
    .client{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-left:6px solid var(--primary);border-radius:12px;padding:12px;background:var(--card);}
    .client.overdue{border-left-color: var(--danger);background: rgba(239,68,68,.08);}
    .client.today{border-left-color: var(--warn);background: rgba(245,158,11,.10);}
    .client.paid{border-left-color: var(--accent);background: rgba(34,197,94,.10);}
    .info{display:grid;gap:6px;}
    @media (min-width:900px){.info{grid-template-columns:1.2fr 1fr 1fr 1fr;}}
    details summary{cursor:pointer;user-select:none;}
    .label{font-size:.78rem;color:var(--muted);}
    .value{font-weight:600;}
    .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;}
    .dialog-backdrop.open{display:flex;}
    .dialog{max-width:520px;width:100%;}
    .dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}

    @media(max-width:600px){
      .client{padding:10px;font-size:14px;}
      .btn{width:100%;padding:15px;}
    }
    @media(min-width:601px) and (max-width:1024px){
      .client{padding:15px;font-size:16px;}
      .btn{width:auto;}
    }

    /* small action buttons for client cards */
    .client .actions .btn { padding: 6px 8px; font-size: 0.85rem; }
    @media(max-width:600px){ .client .actions .btn { padding: 4px 6px; font-size: 0.75rem; } }
    @media(min-width:601px) and (max-width:900px){ .client .actions .btn { padding: 5px 7px; font-size: 0.8rem; } }
    @media(min-width:901px){ .client .actions .btn { padding: 6px 10px; font-size: 0.9rem; } }

    .spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* Fix calendar button dark mode issue */
    input[type="date"] { color-scheme: light !important; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

/* Make client info readable on small screens */
    @media (max-width: 600px) {
      .client .info { display: block; }
      .client .info > div { margin-bottom: 10px; }
      .client .label { font-size: 14px; display: block; margin-bottom: 2px; }
      .client .value, .client .inp { font-size: 16px; width: 100%; }
      .client { font-size: 14px; padding: 12px; }
      .client .actions { flex-direction: column; gap: 6px; }
    }

    /* utility spacing */
    .mb-12 { margin-bottom: 12px; }
    .center { text-align: center; }

    /* footer */
    footer { margin-top: 28px; text-align: center; color: var(--muted); font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="loginView">
      <div class="card" style="max-width:520px;margin:8vh auto;">
        <h1 class="center">Client List Reminders</h1>
        <p class="muted center" style="margin-bottom:14px;">v.03 (modular)</p>
        <div class="row" style="gap:14px;">
          <div class="card">
            <h3>Login</h3>
            <!-- email-only login -->
            <form id="loginForm" class="row" style="gap:10px;margin-top:8px;">
              <input id="loginEmail" type="email" placeholder="Email" autocomplete="username" required />
              <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" required />
              <button class="btn primary" type="submit">Login</button>
              <button id="forgotBtn" class="btn ghost" type="button">Forgot Password?</button>
            </form>
          </div>
          <div class="card">
            <h3>Create Account</h3>
            <button id="createAccountBtn" class="btn success" type="button">Create Account</button>
            <p class="muted" style="margin-top:6px;">Make our client satisfied</p>
          </div>
        </div>
      </div>
    </div>

    <div id="loadingSpinner" class="spinner" style="display:none;margin:20px auto;"></div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="dialog-backdrop" aria-hidden="true">
    <div class="dialog card">
      <h3>Create Account</h3>
      <!-- signup asks ONLY for email + password -->
      <form id="registerForm" class="row" style="gap:10px;">
        <input id="regEmail" type="email" placeholder="Email (used for login & reset)" required />
        <input id="regPassword" type="password" placeholder="Password" required />
        <div class="actions">
          <button class="btn success" type="submit">Create Account</button>
          <button class="btn ghost" type="button" data-close-modal="#registerModal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div id="forgotModal" class="dialog-backdrop" aria-hidden="true">
    <div class="dialog card">
      <h3>Forgot Password</h3>
      <!-- ask for email instead of username -->
      <div class="row" style="gap:10px;">
        <input id="forgotEmail" type="email" placeholder="Enter your email" />
      </div>
      <div class="actions">
        <button class="btn" type="button" data-close-modal="#forgotModal">Cancel</button>
        <button id="forgotSend" class="btn primary" type="button">Send Reset Email</button>
      </div>
    </div>
  </div>

  <!-- APP VIEW -->
  <div id="appView" class="hide">
    <!-- Topbar & Menu -->
    <div class="topbar">
      <div class="brand">📒 Client List Reminders</div>
      <div class="muted" id="whoami"></div>
      <div class="menu-wrap">
        <button id="moreBtn" class="btn" aria-haspopup="true" aria-expanded="false">☰ Menu</button>
        <div id="moreMenu" class="menu" role="menu" aria-hidden="true">
          <div class="item" id="exportExcel">📥 Export to Excel</div>
          <div class="item" id="backupBtn">💾 Backup (download .json)</div>
          <label class="item" for="restoreInput" style="display:block;cursor:pointer;">📤 Restore (upload .json)</label>
          <input id="restoreInput" type="file" accept=".json,application/json" class="hide" />
          <div class="item" id="darkToggle">🌓 Toggle Dark</div>
          <div class="item" id="logoutBtn">🚪 Logout</div>
        </div>
      </div>
    </div>

    <!-- Settings & Email Template -->
    <div class="card mb-12">
      <details>
        <summary><strong>✉️ Email Reminder Template</strong> <span class="muted">(per user)</span></summary>
        <div class="row" style="margin-top:10px;grid-template-columns:1fr;">
          <input id="tplSubject" type="text" placeholder="Subject (e.g., Payment Reminder for {{name}})" />
          <textarea id="tplBody" placeholder="Body. Use {{name}}, {{next}}, {{plan}} tokens."></textarea>
          <button id="saveTpl" class="btn">Save Template</button>
          <p class="muted">Your registered email will be used as the sender by your email app.</p>
        </div>
      </details>
    </div>

    <!-- Add Client (toggleable) -->
    <div class="card mb-12" id="addClientCard">
      <div class="row" style="grid-template-columns:1fr auto; align-items:center;">
        <h3 style="margin:0;">Clients</h3>
        <button id="toggleAddClient" class="btn primary" type="button" aria-expanded="false">+ Add Client</button>
      </div>

      <!-- Hidden form appears only after clicking the button -->
      <form id="clientForm" class="row hide" style="margin-top:10px; grid-template-columns:1.2fr 1fr 1fr 1fr 1fr 1fr auto;">
        <input type="text" id="clientName" placeholder="Client Name" required />
        <input type="email" id="clientEmail" placeholder="Client Email" />
        <input type="text" id="clientPhone" placeholder="Contact No." />
        <input type="text" id="clientAddress" placeholder="Address" />
        <input type="date" id="startDate" required />
        <input type="text" id="clientPlan" placeholder="Plan (e.g. $50)" required />
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn success" type="submit">Save</button>
          <button id="cancelAddClient" class="btn ghost" type="button">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Filters -->
    <div class="card mb-12">
      <div class="row" style="grid-template-columns: 2fr 1fr 1fr;">
        <input id="searchInput" type="text" placeholder="Search by client name…" />
        <select id="filterSelect">
          <option value="all">All</option>
          <option value="due-month">Due this month</option>
          <option value="overdue">Overdue</option>
          <option value="upcoming">Upcoming (later)</option>
        </select>
        <select id="sortSelect">
          <option value="name-asc">Sort: Name ↑</option>
          <option value="name-desc">Sort: Name ↓</option>
          <option value="date-asc">Sort: Next payment ↑</option>
          <option value="date-desc">Sort: Next payment ↓</option>
          <option value="plan-asc">Sort: Plan ↑</option>
          <option value="plan-desc">Sort: Plan ↓</option>
        </select>
      </div>
    </div>

    <!-- Lists -->
    <div>
      <div class="section-title">
        <span>📅 This Month</span>
        <span class="muted" id="countThisMonth">0</span>
      </div>
      <div id="dueList" class="list"></div>

      <div class="section-title" style="margin-top:18px;">
        <span>✅ Paid / Later</span>
        <span class="muted" id="countLater">0</span>
      </div>
      <div id="paidList" class="list"></div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>© 2025 Client Manager. All Rights Reserved.</footer>

  <!-- Generic Dialog (kept for future use) -->
  <div id="dialogBackdrop" class="dialog-backdrop">
    <div class="dialog card">
      <h3 id="dialogTitle">Dialog</h3>
      <div id="dialogBody" class="row"></div>
      <div class="actions">
        <button id="dialogCancel" class="btn">Cancel</button>
        <button id="dialogOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- APP SCRIPT (Firebase Modular) -->
  <script type="module">
    // ===================== Firebase Modular SDK =====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, deleteDoc,
      onSnapshot, serverTimestamp, writeBatch, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

    // ---- Config ----
    const firebaseConfig = {
      apiKey: "AIzaSyD8KyIuPpW4w9vwEwfzemhxYYp2nJy4Io8",
      authDomain: "client-management-f6060.firebaseapp.com",
      projectId: "client-management-f6060",
      storageBucket: "client-management-f6060.appspot.com",
      messagingSenderId: "267148533200",
      appId: "1:267148533200:web:59f74ba662122c81c22dd5",
      measurementId: "G-M6QEGME5SZ"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    try { if (await isSupported()) getAnalytics(app); } catch(_) {}

    // ===================== Utils & State =====================
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const today0 = () => { const d = new Date(); d.setHours(0,0,0,0); return d; };
    function formatDate(d){ return d.toISOString().split('T')[0]; }
    function setTheme(d){ document.documentElement.setAttribute('data-theme', d?'dark':'light'); }
    function escapeHtml(s=''){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}
    function escapeAttr(s=''){return escapeHtml(s)}
    function showSpinner(show){ $('#loadingSpinner').style.display = show ? 'block' : 'none'; }

    // Fast monthly advance without long loops
    function nextPaymentFrom(startDate){
      const now = today0();
      const next = new Date(startDate);
      next.setHours(0,0,0,0);
      if (isNaN(next)) return now; // fallback
      if (next >= now) return next;
      const yDiff = now.getFullYear() - next.getFullYear();
      const mDiff = now.getMonth() - next.getMonth();
      let months = yDiff * 12 + mDiff;
      if (now.getDate() > next.getDate()) months += 1;
      next.setMonth(next.getMonth() + months);
      while (next < now) next.setMonth(next.getMonth() + 1);
      return next;
    }
    function isToday(dateObj){ const t=today0().getTime(); const d=new Date(dateObj); d.setHours(0,0,0,0); return d.getTime()===t; }
    function isThisMonth(dateObj){ const t=today0(); return dateObj.getMonth()===t.getMonth() && dateObj.getFullYear()===t.getFullYear(); }
    function isOverdue(dateObj){ const now=today0(); const d=new Date(dateObj); d.setHours(0,0,0,0); return d<now; }

    let currentUser = null;        // Firebase User
    let currentProfile = null;     // {email, prefs...}
    let clientsCache = [];         // [{id, ...}]
    let unsubClients = null;

    // ===================== Auth & Profiles =====================
    async function register(email, password){
      email = (email||'').trim();
      if(!email || !password) return alert('Please fill email and password.');

      showSpinner(true);
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;

        const profile = {
          email,
          createdAt: serverTimestamp(),
          prefs: {
            darkMode:false,
            tplSubject:'Payment Reminder for {{name}}',
            tplBody:'Hello {{name}},\n\nYour next payment is due on {{next}} for {{plan}}.\n\nThank you.'
          }
        };
        await setDoc(doc(db, 'users', uid), profile);

        alert('Account created! You can now login.');
        closeModal('#registerModal');
      } catch(err){
        console.error(err);
        alert(err.message || 'Could not create account.');
      } finally {
        showSpinner(false);
      }
    }

    async function login(email, password){
      email = (email||'').trim();
      if(!email || !password) return;
      showSpinner(true);
      try{
        await signInWithEmailAndPassword(auth, email, password);
      } catch(err){
        console.error(err);
        alert('Check your email or password.');
      } finally {
        showSpinner(false);
      }
    }

    function logout(){
      if(unsubClients) { unsubClients(); unsubClients = null; }
      clientsCache = [];
      currentProfile = null;
      signOut(auth);
      $('#appView').classList.add('hide');
      $('#loginView').classList.remove('hide');
      setTheme(false);
      $('#loginForm').reset();
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        $('#whoami').textContent = '';
        $('#loginView').classList.remove('hide');
        $('#appView').classList.add('hide');
        return;
      }
      currentUser = user;

      // Profile
      const profSnap = await getDoc(doc(db, 'users', user.uid));
      currentProfile = profSnap.exists() ? profSnap.data() : { email: user.email, prefs:{} };
      setTheme(!!currentProfile?.prefs?.darkMode);

      // show email only
      $('#whoami').textContent = currentProfile.email || user.email || '';

      // Prefill template
      const p = currentProfile.prefs || {};
      $('#tplSubject').value = p.tplSubject || 'Payment Reminder for {{name}}';
      $('#tplBody').value    = p.tplBody || 'Hello {{name}},\n\nYour next payment is due on {{next}} for {{plan}}.\n\nThank you.';

      // Subscribe to clients
      if(unsubClients) unsubClients();
      const qClients = query(collection(db, 'users', user.uid, 'clients'), orderBy('name'));
      unsubClients = onSnapshot(qClients, (snap)=>{
        clientsCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        render();
      });

      $('#loginView').classList.add('hide');
      $('#appView').classList.remove('hide');
    });

    // ===================== Firestore CRUD =====================
    function getClients(){ return clientsCache || []; }
    function statusFor(c){
      const next = nextPaymentFrom(new Date(c.startDate));
      if (isToday(next)) return 'Due Today';
      if (isThisMonth(next)) return 'Due This Month';
      return 'Paid for Next Month';
    }

    async function addClient(c){
      if(!currentUser) return;
      await addDoc(collection(db, 'users', currentUser.uid, 'clients'), c);
    }
    async function updateClient(id, patch){
      if(!currentUser || !id) return;
      await updateDoc(doc(db, 'users', currentUser.uid, 'clients', id), patch);
    }
    async function deleteClient(id){
      if(!currentUser || !id) return;
      await deleteDoc(doc(db, 'users', currentUser.uid, 'clients', id));
    }
    async function savePrefs(patch){
      if(!currentUser) return;
      const next = { ...(currentProfile||{}), prefs: { ...(currentProfile?.prefs||{}), ...patch } };
      await updateDoc(doc(db, 'users', currentUser.uid), { prefs: next.prefs });
      currentProfile = next;
    }

    // ===================== Render =====================
    function render(){
      const dueWrap = $('#dueList'), paidWrap = $('#paidList');
      dueWrap.innerHTML=''; paidWrap.innerHTML='';

      let list = getClients().map((c,i)=>({ ...c, _index:i, _next: nextPaymentFrom(new Date(c.startDate)) }));

      const qstr = $('#searchInput').value.trim().toLowerCase();
      if(qstr) list = list.filter(c => (c.name||'').toLowerCase().includes(qstr));

      const filt = $('#filterSelect').value;
      if(filt==='due-month') list = list.filter(c => isThisMonth(c._next));
      if(filt==='overdue') list = list.filter(c => isOverdue(c._next));
      if(filt==='upcoming') list = list.filter(c => !isThisMonth(c._next) && !isOverdue(c._next));

      const sort = $('#sortSelect').value;
      const n = v => (parseFloat((v||'').replace(/[^0-9.]/g,''))||0);
      const cmp = {
        'name-asc': (a,b)=>(a.name||'').localeCompare(b.name||''),
        'name-desc':(a,b)=>(b.name||'').localeCompare(a.name||''),
        'date-asc': (a,b)=> a._next - b._next,
        'date-desc':(a,b)=> b._next - a._next,
        'plan-asc': (a,b)=> n(a.plan) - n(b.plan),
        'plan-desc':(a,b)=> n(b.plan) - n(a.plan),
      }[sort] || ((a,b)=>0);
      list.sort(cmp);

      let countThis=0, countLater=0;
      list.forEach(c=>{
        const nextStr = formatDate(c._next);
        const dueToday = isToday(c._next);
        const inThisMonth = isThisMonth(c._next);
        const overdue = isOverdue(new Date(c._next.getTime()-86400000));

        const card = document.createElement('div');
        card.className = 'client';
        if (c.justPaid) card.classList.add('paid');
        if (dueToday) card.classList.add('today');
        if (overdue) card.classList.add('overdue');

        card.dataset.i = String(c._index);

        const details = `
          <details>
            <summary class="muted">More info</summary>
            <div class="row" style="margin-top:8px; grid-template-columns: 1fr 1fr;">
              <label class="label">Email</label><input class="inp email" data-i="${c._index}" type="email" value="${escapeAttr(c.email||'')}"/>
              <label class="label">Phone</label><input class="inp phone" data-i="${c._index}" type="text" value="${escapeAttr(c.phone||'')}"/>
              <label class="label">Address</label><input class="inp addr" data-i="${c._index}" type="text" value="${escapeAttr(c.address||'')}"/>
              <label class="label">Notes</label><textarea class="inp notes" data-i="${c._index}">${escapeHtml(c.notes||'')}</textarea>
            </div>
          </details>`;

        card.innerHTML = `
          <div class="info">
            <div><div class="label">Name</div><div class="value">${escapeHtml(c.name||'')}</div></div>
            <div><div class="label">Plan</div><div><input class="inp plan" data-i="${c._index}" type="text" value="${escapeAttr(c.plan||'')}" /></div></div>
            <div><div class="label">Start Date</div><div><input class="inp date" data-i="${c._index}" type="date" value="${escapeAttr(c.startDate||'')}" /></div></div>
            <div><div class="label">Next Payment</div><div class="value">${dueToday?'🟧 Today':nextStr}</div></div>
          </div>
          <div class="actions" style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn success" data-action="paid" data-i="${c._index}">✅ Mark Paid</button>
            <button class="btn" data-action="email" data-i="${c._index}">✉️ Email</button>
            <button class="btn danger" data-action="del" data-i="${c._index}">🗑️ Delete</button>
          </div>
          ${details}
        `;
        if(inThisMonth){ dueWrap.appendChild(card); countThis++; } else { paidWrap.appendChild(card); countLater++; }
      });
      $('#countThisMonth').textContent = countThis;
      $('#countLater').textContent = countLater;
    }

    // ===================== Handlers (Event Delegation) =====================
    async function onMarkPaid(i){
      const item = getClients()[i]; if(!item) return;
      if(!confirm('Mark as paid and move next payment by 1 month?')) return;
      const d = new Date(item.startDate); d.setMonth(d.getMonth()+1);
      await updateClient(item.id, { startDate: formatDate(d) });
    }
    async function onDelete(i){
      const item = getClients()[i]; if(!item) return;
      if (!confirm(`Delete ${item.name || 'this client'}? This cannot be undone.`)) return;
      await deleteClient(item.id);
    }
    async function onEdit(i, field, value){
      const item = getClients()[i]; if(!item) return;
      await updateClient(item.id, { [field]: value });
    }
    function onEmail(i){
      const c = getClients()[i]; if(!c) return;
      const next = formatDate(nextPaymentFrom(new Date(c.startDate)));
      const p = currentProfile?.prefs || {};
      const subject = encodeURIComponent((p.tplSubject || 'Payment Reminder for {{name}}')
        .replace(/{{name}}/g, c.name||'').replace(/{{next}}/g, next).replace(/{{plan}}/g, c.plan||''));
      const body = encodeURIComponent((p.tplBody || 'Hello {{name}},\n\nYour next payment is due on {{next}} for {{plan}}.\n\nThank you.')
        .replace(/{{name}}/g, c.name||'').replace(/{{next}}/g, next).replace(/{{plan}}/g, c.plan||''));
      const to = encodeURIComponent(c.email || '');
      const footer = `%0D%0A%0D%0ASent from: ${encodeURIComponent(auth.currentUser?.email||'')}`;
      location.href = `mailto:${to}?subject=${subject}&body=${body}${footer}`;
    }

    function exportToExcel(){
      const list = getClients().map(c=>({ ...c, _next: nextPaymentFrom(new Date(c.startDate)) }));
      const order = { 'Due Today':0, 'Due This Month':1, 'Paid for Next Month':2 };
      list.sort((a,b)=> (order[statusFor(a)] - order[statusFor(b)]) || (a._next - b._next));
      const data = list.map(c=>({
        "Client Name": c.name, "Email": c.email || '', "Phone": c.phone || '',
        "Address": c.address || '', "Plan": c.plan || '', "Start Date": c.startDate,
        "Next Payment": formatDate(c._next), "Status": statusFor(c), "Notes": c.notes || ''
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Clients");
      const base = (currentUser?.email?.split('@')[0]) || 'user';
      XLSX.writeFile(wb, `${base}_Clients.xlsx`);
    }
    function download(filename, text){
      const blob = new Blob([text], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }
    function backupUser(){
      const payload = { email: currentUser?.email || '', clients: getClients() };
      const base = (currentUser?.email?.split('@')[0]) || 'user';
      download(`${base}_backup.json`, JSON.stringify(payload,null,2));
    }
    async function restoreUser(file) {
      if (!currentUser) return;
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const obj = JSON.parse(reader.result);
          if (!obj || !Array.isArray(obj.clients)) throw new Error('Invalid file');

          const colRefPath = ['users', currentUser.uid, 'clients'];
          const batch = writeBatch(db);

          // Delete existing clients
          clientsCache.forEach(c => batch.delete(doc(db, ...colRefPath, c.id)));

          // Add imported clients
          obj.clients.forEach(c => {
            const copy = { ...c };
            delete copy.id; delete copy._index; delete copy._next; delete copy.justPaid;
            const newRef = doc(collection(db, ...colRefPath));
            batch.set(newRef, copy);
          });

          await batch.commit();
          alert('Restore complete!');
        } catch (e) {
          console.error(e);
          alert('Could not restore — invalid file.');
        }
      };
      reader.readAsText(file);
    }
    async function toggleDark(){
      const current = !!(currentProfile?.prefs?.darkMode);
      await savePrefs({ darkMode: !current });
      setTheme(!current);
    }
    async function saveTplClick(){
      const subj = $('#tplSubject').value;
      const body = $('#tplBody').value;
      await savePrefs({ tplSubject: subj, tplBody: body });
      alert('Template saved!');
    }

    // ===================== Simple dialog helpers (kept) =====================
    function showDialog(title, bodyNode, onOk, okLabel='OK', cancelLabel='Cancel'){
      $('#dialogTitle').textContent = title;
      const body = $('#dialogBody'); body.innerHTML=''; if(bodyNode) body.appendChild(bodyNode);
      $('#dialogBackdrop').classList.add('open');
      $('#dialogOk').textContent = okLabel; $('#dialogCancel').textContent = cancelLabel;
      const okHandler = async ()=>{ if(typeof onOk === 'function'){ const res = await onOk(); if(res === false) return; } closeDialog(); };
      $('#dialogOk').onclick = okHandler;
      $('#dialogCancel').onclick = closeDialog;
    }
    function closeDialog(){ $('#dialogBackdrop').classList.remove('open'); }

    // ===================== UI Wiring =====================
    function openModal(sel){ const el = document.querySelector(sel); if (el) el.classList.add('open'); }
    function closeModal(sel){ const el = document.querySelector(sel); if (el) el.classList.remove('open'); }
    window.closeModal = closeModal;

    // Login + Register
    $('#createAccountBtn').addEventListener('click', ()=> openModal('#registerModal'));
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-close-modal]');
      if (btn){ closeModal(btn.getAttribute('data-close-modal')); }
    });

    $('#registerForm').addEventListener('submit', async e=>{
      e.preventDefault();
      await register($('#regEmail').value, $('#regPassword').value);
      e.target.reset();
    });
    $('#loginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      await login($('#loginEmail').value, $('#loginPassword').value);
    });

    // Forgot password (email-based)
    $('#forgotBtn').addEventListener('click', ()=> openModal('#forgotModal'));
    $('#forgotSend').addEventListener('click', async ()=>{
      const email = $('#forgotEmail').value.trim();
      if(!email) return alert('Please enter your email.');
      try{
        await sendPasswordResetEmail(auth, email);
        alert(`Password reset email sent to ${email}`);
        closeModal('#forgotModal');
      }catch(e){ console.error(e); alert('Could not send reset email.'); }
    });

    // Menu & misc
    $('#moreBtn').addEventListener('click', ()=>{
      const menu = $('#moreMenu');
      const isOpen = menu.classList.toggle('open');
      $('#moreBtn').setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      menu.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    });
    document.addEventListener('click', e=>{ if(!e.target.closest('.menu-wrap')) $('#moreMenu').classList.remove('open'); });
    $('#exportExcel').addEventListener('click', exportToExcel);
    $('#backupBtn').addEventListener('click', backupUser);
    $('#restoreInput').addEventListener('change', e=>{ if(e.target.files?.[0]) restoreUser(e.target.files[0]); e.target.value=''; $('#moreMenu').classList.remove('open'); });
    $('#darkToggle').addEventListener('click', toggleDark);
    $('#logoutBtn').addEventListener('click', logout);

    // Filters & search (debounced)
    let searchTimeout;
    $('#searchInput').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => { render(); }, 300);
    });
    $('#filterSelect').addEventListener('change', render);
    $('#sortSelect').addEventListener('change', render);

    // === Add Client (toggle UI) ===
    const addBtn = $('#toggleAddClient');
    const addForm = $('#clientForm');
    const cancelAdd = $('#cancelAddClient');

    function setAddForm(open){
      addForm.classList.toggle('hide', !open);
      addBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
      addBtn.textContent = open ? 'Close' : '+ Add Client';
      if (open) addForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    addBtn.addEventListener('click', ()=> setAddForm(addForm.classList.contains('hide')));
    cancelAdd.addEventListener('click', ()=>{
      addForm.reset();
      setAddForm(false);
    });

    // Add client (Save)
    $('#clientForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = $('#clientName').value.trim();
      const email = $('#clientEmail').value.trim();
      const phone = $('#clientPhone').value.trim();
      const address = $('#clientAddress').value.trim();
      const startDate = $('#startDate').value;
      const plan = $('#clientPlan').value.trim();
      if (!name || !startDate) return;
      await addClient({ name, email, phone, address, startDate, plan, notes: '' });
      e.target.reset();
      setAddForm(false);
    });

    // Event delegation for lists (clicks)
    document.addEventListener('click', async (e)=>{
      const actionBtn = e.target.closest('.client .actions .btn');
      if (actionBtn){
        const i = +actionBtn.dataset.i;
        const action = actionBtn.dataset.action;
        if (action === 'paid') return onMarkPaid(i);
        if (action === 'del') return onDelete(i);
        if (action === 'email') return onEmail(i);
      }
    });

    // Event delegation for inputs (blur/change)
    document.addEventListener('change', async (e)=>{
      const inp = e.target;
      if (inp.matches('.inp.date')){
        const i = +inp.dataset.i;
        await onEdit(i, 'startDate', inp.value);
      }
    });
    document.addEventListener('blur', async (e)=>{
      const inp = e.target;
      if (!(inp instanceof HTMLElement)) return;
      if (inp.matches('.inp.plan')) { const i = +inp.dataset.i; await onEdit(i, 'plan', inp.value); }
      if (inp.matches('.inp.email')){ const i = +inp.dataset.i; await onEdit(i, 'email', inp.value); }
      if (inp.matches('.inp.phone')){ const i = +inp.dataset.i; await onEdit(i, 'phone', inp.value); }
      if (inp.matches('.inp.addr')) { const i = +inp.dataset.i; await onEdit(i, 'address', inp.value); }
      if (inp.matches('.inp.notes')){ const i = +inp.dataset.i; await onEdit(i, 'notes', inp.value); }
    }, true);

    // Save template
    $('#saveTpl').addEventListener('click', saveTplClick);

    // ===================== Firestore Rules (update suggestion) =====================
    /*
    With email-only auth and no "usernames" collection, a minimal rule set could be:

    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        match /users/{userId} {
          allow read, update, delete: if request.auth != null && request.auth.uid == userId;
          allow create: if request.auth != null && request.auth.uid == userId;

          match /clients/{clientId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
          }
        }
      }
    }
    */
  </script>
</body>
</html>
